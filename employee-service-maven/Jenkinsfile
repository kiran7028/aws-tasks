pipeline {

    agent any

    tools {
        jdk 'jdk17'
        maven 'maven3'
    }

    environment {
        JAVA_HOME = "${tool 'jdk17'}"
        PATH = "${JAVA_HOME}/bin:${PATH}"
        DOCKER_IMAGE = "employee-service"
        DOCKER_REGISTRY = "your-dockerhub-username"
    }

    stages {

        stage('Build') {
            steps {
                echo "Building project..."
                dir('employee-service-maven') {
                    sh "mvn clean package -DskipTests"
                }
            }
        }

        stage('Run Tests') {
            steps {
                echo "Running unit tests..."
                dir('employee-service-maven') {
                    sh "mvn test"
                }
            }
            post {
                always {
                    junit 'employee-service-maven/target/surefire-reports/*.xml'
                }
            }
        }

        stage('Archive Artifact') {
            steps {
                echo "Archiving build artifacts..."
                archiveArtifacts artifacts: 'employee-service-maven/target/*.jar', fingerprint: true
            }
        }

        stage('Build Docker Image') {
            when {
                expression { return fileExists('employee-service-maven/Dockerfile') }
            }
            steps {
                echo "Building Docker image..."
                dir('employee-service-maven') {
                    sh """
                        docker build -t $DOCKER_REGISTRY/$DOCKER_IMAGE:latest .
                    """
                }
            }
        }

        stage('Push Docker Image') {
            when {
                expression { return fileExists('employee-service-maven/Dockerfile') }
            }
            steps {
                echo "Pushing image to Docker Hub..."
                withCredentials([usernamePassword(credentialsId: 'dockerhub-creds',
                     usernameVariable: 'USER', passwordVariable: 'PASS')]) {

                    sh "echo $PASS | docker login -u $USER --password-stdin"
                    sh "docker push $DOCKER_REGISTRY/$DOCKER_IMAGE:latest"
                }
            }
        }

        stage('Deploy (Optional)') {
            when { expression { return false } } // enable when needed
            steps {
                echo "Deploying application..."
                // Example: scp/copy or kubectl apply
            }
        }
    }

    post {
        success {
            echo "Build completed successfully!"
        }
        failure {
            echo "Build failed! Check logs."
        }
    }
}